<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OSHA Incidents</title>
</head>
<body>
  <h1>OSHA Severe Injury Reports</h1>
  <section id="osha-widget" style="padding:24px; border-top:1px solid #e5e7eb">
<h2>Recent OSHA Severe Injuries</h2>
<div style="margin:8px 0">
<label>State: <input id="osha-state" value="WI" size="4" /></label>
<label style="margin-left:12px">Lookback days: <input id="osha-days" value="90" size="4" /></label>
<button id="osha-refresh">Refresh</button>
</div>
<div id="osha-summary" style="margin:12px 0; font-size:0.95rem; line-height:1.35"></div>
<div id="osha-stats" style="margin:12px 0"></div>
<div id="osha-list" style="display:grid; gap:10px"></div>
</section>


<script type="module">
async function loadJSON(path){
const res = await fetch(path, { cache: 'no-store' });
if(!res.ok) throw new Error(`Failed to load ${path}`);
return await res.json();
}


function renderStats(stats){
const topNAICS = (stats.byNAICS||[]).map(([k,v])=>`<li>${k}: ${v}</li>`).join('');
const topCity = (stats.byCity||[]).map(([k,v])=>`<li>${k}: ${v}</li>`).join('');
return `
<div><strong>Total incidents:</strong> ${stats.total}</div>
<div>Hospitalizations: ${stats.counts.hospitalization} · Amputations: ${stats.counts.amputation} · Loss of eye: ${stats.counts.lossOfEye}</div>
<details style="margin-top:6px"><summary>Top NAICS</summary><ul>${topNAICS}</ul></details>
<details style="margin-top:6px"><summary>Top Cities</summary><ul>${topCity}</ul></details>
`;
}


function cardHTML(it){
const badge = [it.hospitalization&&"Hosp", it.amputation&&"Amp", it.lossOfEye&&"Eye"].filter(Boolean).join(" · ");
return `
<article style="border:1px solid #e5e7eb; border-radius:12px; padding:12px">
<div style="font-weight:600">${it.employer || "(Employer withheld)"}</div>
<div style="font-size:0.9rem; color:#555">${it.city||""}, ${it.state||""} · ${it.naics||"NAICS ?"} ${badge?`· <span>${badge}</span>`:""}</div>
<div style="margin-top:6px">${it.description || "(No description)"}</div>
<div style="font-size:0.85rem; color:#666; margin-top:4px">${new Date(it.date).toLocaleDateString()}</div>
</article>`;
}


async function hydrate(){
const sum = await loadJSON('/data/osha-summary.json');
const inc = await loadJSON('/data/osha-incidents.json');
document.getElementById('osha-summary').innerHTML = sum.ai_summary
? `<em>${sum.ai_summary}</em>`
: `<em>(AI summary not configured. Add OPENAI_API_KEY to enable.)</em>`;
document.getElementById('osha-stats').innerHTML = renderStats(sum.stats);
document.getElementById('osha-list').innerHTML = inc.incidents.map(cardHTML).join('');
document.getElementById('osha-state').value = sum.state || 'WI';
document.getElementById('osha-days').value = sum.days || 90;
}


async function refresh(){
const st = document.getElementById('osha-state').value.trim().toUpperCase() || 'WI';
const dy = document.getElementById('osha-days').value.trim() || '90';
// You can make these inputs feed the Action via repo variables, but for a static site
// we just display the locally built files and show the chosen filters in the header.
alert(`Filters are built at Action time. Current data is for ${st}, last ${dy} days.\n\nTo change permanently, edit STATE/DAYS env in the workflow and re-run.`);
}


hydrate();


document.getElementById('osha-refresh').addEventListener('click', refresh);
</script>
</body>
</html>
